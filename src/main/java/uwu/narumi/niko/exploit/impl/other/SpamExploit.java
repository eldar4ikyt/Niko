package uwu.narumi.niko.exploit.impl.other;

import java.util.Objects;
import java.util.regex.Pattern;
import uwu.narumi.niko.exception.ExploitException;
import uwu.narumi.niko.exploit.Exploit;
import uwu.narumi.niko.exploit.ExploitInfo;
import uwu.narumi.niko.exploit.ExploitType;
import uwu.narumi.niko.exploit.argument.Argument;

@ExploitInfo(
    name = "Spam",
    type = ExploitType.OTHER,
    usage = ".exploit spam <command, for example: \"/msg\"> <delay> <message>",
    description = "Some shitty spammer (msg all)"
)
public class SpamExploit extends Exploit {

  private static final Pattern validUserPattern = Pattern.compile("^[a-zA-Z0-9_]{2,16}$");

  public SpamExploit() {
    super(
        new Argument("command, for example: \"/msg\"", 0, String.class),
        new Argument("delay", 1, Long.class),
        new Argument("message", 2, String[].class)
    );
  }

  @Override
  public void execute(Object... args) throws ExploitException {
    if (mc.thePlayer != null && !mc.isSingleplayer()
        && mc.getNetHandler().getPlayerInfoMap() != null) {

      mc.getNetHandler().getPlayerInfoMap()
          .stream()
          .filter(Objects::nonNull)
          .filter(playerInfo -> playerInfo.getGameProfile().getName() != null)
          .filter(playerInfo -> validUserPattern.matcher(playerInfo.getGameProfile().getName())
              .matches())
          .forEach(playerInfo -> {
            if (mc.thePlayer == null || mc.getNetHandler().getPlayerInfoMap() == null) {
              throw new ThreadDeath();
            }

            try {
              mc.thePlayer.sendChatMessage(
                  args[0] + " " + playerInfo.getGameProfile().getName() + " " + args[2]);
              System.out
                  .println(args[0] + " " + playerInfo.getGameProfile().getName() + " " + args[2]);
              Thread.sleep((Long) args[1]);
            } catch (Exception e) {
              e.printStackTrace();
            }
          });
    }
  }
}
